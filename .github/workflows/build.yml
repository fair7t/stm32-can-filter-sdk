name: Build SDK
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout SDK
        uses: actions/checkout@v4

      - name: Add github.com to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t ed25519 github.com >> ~/.ssh/known_hosts

      - name: Add SSH key for private core
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.CORE_SSH_KEY }}

      - name: Fetch private core
        run: |
          git clone git@github.com:fair7t/stm32-can-filter-core.git core

      - name: Build core static lib
        run: |
          sudo apt-get update && sudo apt-get install -y gcc-arm-none-eabi make
          make -C core
          mkdir -p lib
          cp core/build/libcanfilter_core.a lib/

      - name: Pack SDK
        run: |
          # .keep-файлы помогут, если каталоги пустые
          touch include/.keep examples/.keep docs/.keep || true
          tar -czf sdk_bundle.tar.gz include/ examples/ docs/ lib/

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          files: |
            lib/libcanfilter_core.a
            sdk_bundle.tar.gz
